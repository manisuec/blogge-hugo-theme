<head>
  <meta charset="utf-8" />
  {{- if lt (.Title | len) 30 -}}
  <title>{{ .Title }} | Parenting Quotient</title>
  {{- else }}
  <title>{{ .Title }}</title>
  {{ end }}

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
  
  <!-- DNS Prefetch and Preconnect for external resources -->
  <link rel="dns-prefetch" href="//fonts.googleapis.com">
  <!-- <link rel="dns-prefetch" href="//fonts.gstatic.com"> -->
  <!-- <link rel="dns-prefetch" href="//www.googletagmanager.com"> -->
  <!-- <link rel="dns-prefetch" href="//www.clarity.ms"> -->
  <link rel="dns-prefetch" href="//res.cloudinary.com">
  
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://res.cloudinary.com" crossorigin>
  
  <!-- Optimized font loading with font-display: swap -->
  <link rel="preload" href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,400;0,700;1,400&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,400;0,700;1,400&display=swap"></noscript>

  <!-- Preload critical images -->
  {{ if .Params.thumbnail }}
    <link rel="preload" href="{{ .Params.thumbnail }}" as="image" type="image/webp">
  {{ else if .Site.Params.mainThumb }}
    <link rel="preload" href="{{ .Site.Params.mainThumb }}" as="image" type="image/webp">
  {{ end }}

  <!-- Enhanced Schema.org Markup -->
  {{ partial "schema.html" . }}

  {{ with .Site.Params.author }}
  <meta name="author" content="{{ . }}">
  {{ end }}
  {{- if .Description -}}
  <meta name="description" content="{{ .Description | safeHTML }}" />
  {{- else if .IsPage -}}
  <meta name="description" content="{{ .Summary | plainify }}" />
  {{- else if .Site.Params.description -}}
  <meta name="description" content="{{ .Site.Params.description | safeHTML }}" />
  {{- end -}}
  
  <!-- Twitter Card Meta Tags -->
  {{ if  .Site.Params.twitterUsername }}
  <meta name="twitter:card" content="{{ if .Params.thumbnail }}summary_large_image{{else}}summary{{end}}">
  <meta name="twitter:title" content="{{ if .IsHome }}{{ .Site.Title }}{{ else }}{{ .Title }} &middot; {{ .Site.Title }}{{ end }}">
  <meta name="twitter:description" content="{{- if .Description -}}{{ .Description | safeHTML }}{{- else if .Summary -}}{{ .Summary | plainify }}{{- else if .Site.Params.description -}}{{ .Site.Params.description | safeHTML }}{{- end -}}">
  <meta name="twitter:site" content="{{ .Site.Params.twitter }}">
  <meta name="twitter:creator" content="{{ .Site.Params.twitterUsername }}">
  {{ if .Params.thumbnail }}
    <meta name="twitter:image" content="{{ .Params.thumbnail }}">
    <meta name="twitter:image:alt" content="{{ .Title }}">
  {{ else if .Site.Params.mainThumb }} 
    <meta name="twitter:image" content="{{ .Site.Params.mainThumb }}">
    <meta name="twitter:image:alt" content="{{ .Site.Title }}">
  {{ end }}
  {{ end }}

  <!-- Open Graph Meta Tags -->
  <meta property="og:locale" content="en-US">
  <meta property="og:type" content="{{ if .IsPage }}article{{ else }}website{{ end }}">
  <meta property="og:title" content="{{ if .IsHome }}{{ .Site.Title }}{{ else }}{{ .Title }} &middot; {{ .Site.Title }}{{ end }}">
  <meta property="og:description" content="{{- if .Description -}}{{ .Description | safeHTML }}{{ .Summary | plainify }}{{- else if .Site.Params.description -}}{{ .Site.Params.description | safeHTML }}{{- end -}}">
  <meta property="og:url" content="{{ .Permalink }}">
  <meta property="og:site_name" content="{{ .Site.Title }}">
  {{ if .Params.thumbnail }}
    <meta property="og:image" content="{{ .Params.thumbnail }}">
    <meta property="og:image:secure_url" content="{{ .Params.thumbnail }}">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:image:alt" content="{{ .Title }}">
  {{ else if .Site.Params.mainThumb }} 
    <meta property="og:image" content="{{ .Site.Params.mainThumb }}">
    <meta property="og:image:secure_url" content="{{ .Site.Params.mainThumb }}">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:image:alt" content="{{ .Site.Title }}">
  {{ end }}
  {{ range .Params.categories }}<meta property="article:section" content="{{ . }}">{{ end }}
  {{ if isset .Params "date" }}<meta property="article:published_time" content="{{ (time .Date).Format "2006-01-02T15:04:05Z" }}">{{ end }}
  
  {{ hugo.Generator }}

  <!-- Canonical URL and RSS -->
  <link rel="canonical" href="{{ .Permalink }}" />
  {{- with .OutputFormats.Get "RSS" }}
  <link href="{{ .Permalink }}" rel="alternate" type="application/rss+xml" title="{{ $.Site.Title }}" />
  <link href="{{ .Permalink }}" rel="feed" type="application/rss+xml" title="{{ $.Site.Title }}" />
  {{- end -}}

  <!-- Optimized CSS Loading with Critical CSS -->
  {{ $criticalCSS := resources.Get "scss/critical.scss" | css.Sass | minify }}
  {{ $mainCSS := resources.Get "scss/style.scss" | css.Sass | minify }}
  
  {{ if hugo.IsProduction }}
    {{ $criticalCSS = $criticalCSS | fingerprint }}
    {{ $mainCSS = $mainCSS | fingerprint }}
  {{ end }}
  
  <!-- Inline critical CSS -->
  <style>{{ $criticalCSS.Content | safeCSS }}</style>
  
  <!-- Load main CSS with preload -->
  <link rel="preload" href="{{ $mainCSS.RelPermalink }}" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="{{ $mainCSS.RelPermalink }}"></noscript>

  <!-- Favicon with multiple formats -->
  <link rel="icon" href="{{ "/images/favicon.ico" | absURL }}" type="image/x-icon" />
  <link rel="shortcut icon" href="{{ "/images/favicon.ico" | absURL }}" type="image/x-icon" />
  <link rel="apple-touch-icon" href="{{ "/images/apple-touch-icon.png" | absURL }}" sizes="180x180">
  <link rel="icon" type="image/png" href="{{ "/images/favicon-32x32.png" | absURL }}" sizes="32x32">
  <link rel="icon" type="image/png" href="{{ "/images/favicon-16x16.png" | absURL }}" sizes="16x16">
  <link rel="manifest" href="{{ "/manifest.json" | absURL }}">
  
  <!-- Defer non-critical JavaScript -->
  {{ $vendorJS := resources.Get "js/vendor.js" | minify }}
  {{ $mainJS := resources.Get "js/script.js" | minify }}
  
  {{ if hugo.IsProduction }}
    {{ $vendorJS = $vendorJS | fingerprint }}
    {{ $mainJS = $mainJS | fingerprint }}
  {{ end }}
  
  <script defer src="{{ $vendorJS.RelPermalink }}"></script>
  <script defer src="{{ $mainJS.RelPermalink }}"></script>
  
  <!-- Google Analytics with improved loading -->
  {{ if .Site.Params.gtagManager }}
  <script async src="https://www.googletagmanager.com/gtag/js?id={{ .Site.Params.gtagManager }}"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', "{{ .Site.Params.gtagManager }}", {
      'anonymize_ip': true,
      'cookie_flags': 'SameSite=None;Secure'
    });
  </script>
  {{ end }}
  
  <!-- MS Clarity with improved loading -->
  {{- if .Site.Params.msclarity.enable -}}
    <script type="text/javascript">
      (function(c,l,a,r,i,t,y){
          c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
          t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
          y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
      })(window, document, "clarity", "script", "{{ .Site.Params.msclarity.accountId }}");
    </script>
  {{- end -}}
</head>